{
	"name": "Vehicle Search",
	"serverCode": "/* Vehicle Work History (Workshop) â€” hide results until search\n * - Results/pagination/modal render only when ?veh=â€¦ is present and non-empty\n * - AJAX autocomplete (?ajax=veh_suggest&term=â€¦) unchanged\n * - Run-once guard to avoid duplicate output\n */\n\n//////////////////////////// RUN-ONCE + AJAX SHORT-CIRCUIT ////////////////////////////\nif (isset($_GET['ajax']) && $_GET['ajax'] === 'veh_suggest') {\n    header('Content-Type: application/json; charset=UTF-8');\n\n    $vh_norm_sql = \"REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(UPPER(COALESCE(vehNo,'')),'-',''),' ',''),'/', ''),'.',''),'_',''),':',''), '\\t','')\";\n    $term = isset($_GET['term']) ? trim((string)$_GET['term']) : '';\n    $out  = [];\n\n    if ($term !== '') {\n        $termEsc  = addslashes($term);\n        $termNorm = strtoupper(preg_replace('/[^A-Z0-9]/','', $term));\n        $termNormEsc = addslashes($termNorm);\n\n        $sql = \"\n            SELECT vehNo\n            FROM mentain_workshop\n            WHERE COALESCE(vehNo,'') <> ''\n              AND (\n                    UPPER(vehNo) LIKE UPPER('%{$termEsc}%')\n                 OR {$vh_norm_sql} LIKE '%{$termNormEsc}%'\n              )\n            GROUP BY vehNo\n            ORDER BY MAX(reqID) DESC\n            LIMIT 20\n        \";\n        $rs = DB::Query($sql);\n        while ($rs && ($r = $rs->fetchAssoc())) {\n            $v = trim((string)$r['vehNo']);\n            if ($v !== '') $out[] = ['label'=>$v, 'value'=>$v];\n        }\n\n        if (!$out) {\n            $rs = DB::Query(\"\n                SELECT vehNo\n                FROM mentain_workshop\n                WHERE COALESCE(vehNo,'') <> ''\n                GROUP BY vehNo\n                ORDER BY MAX(reqID) DESC\n                LIMIT 10\n            \");\n            while ($rs && ($r = $rs->fetchAssoc())) {\n                $v = trim((string)$r['vehNo']);\n                if ($v !== '') $out[] = ['label'=>$v, 'value'=>$v];\n            }\n        }\n    }\n\n    echo json_encode($out);\n    exit;\n}\nif (defined('VH_RENDERED')) return;\ndefine('VH_RENDERED', true);\n\n//////////////////////////// Config ////////////////////////////\n$STAFF_DB  = 'nas_pcr';\n$STORES_DB = 'stores';\n\n//////////////////////////// LOCAL helpers ////////////////////////////\nif (!function_exists('vh_one'))        { function vh_one($sql){ $rs=DB::Query($sql); return $rs ? $rs->fetchAssoc() : null; } }\nif (!function_exists('vh_all'))        { function vh_all($sql){ $o=[]; $rs=DB::Query($sql); while($rs && ($r=$rs->fetchAssoc())) $o[]=$r; return $o; } }\nif (!function_exists('vh_h'))          { function vh_h($s){ return htmlspecialchars((string)$s, ENT_QUOTES); } }\nif (!function_exists('vh_i'))          { function vh_i($n){ return number_format((int)$n); } }\nif (!function_exists('vh_d'))          { function vh_d($d){ if(!$d||$d==='0000-00-00'||$d==='0000-00-00 00:00:00') return 'â€”'; return date('M j, Y', strtotime($d)); } }\nif (!function_exists('vh_dt'))         { function vh_dt($d){ if(!$d||$d==='0000-00-00 00:00:00') return 'â€”'; return date('M j, Y H:i', strtotime($d)); } }\nif (!function_exists('vh_statusText')) { function vh_statusText($s){ if($s==2) return 'Work Order Pending'; if($s==3) return 'Work Order Submitted'; if($s==4) return 'Vehicle Ready'; return (string)$s; } }\nif (!function_exists('vh_statusClass')){ function vh_statusClass($s){ if($s==4) return 'ok'; if($s==3) return 'warn'; if($s==2) return 'bad'; return 'neutral'; } }\nif (!function_exists('vh_param'))      {\n  function vh_param($name,$default=''){\n    if(function_exists('postvalue')){ $v=postvalue($name); if($v!==null && $v!=='') return $v; }\n    return $_REQUEST[$name] ?? $default;\n  }\n}\nif (!function_exists('vh_norm'))       { function vh_norm($s){ return strtoupper(preg_replace('/[^A-Z0-9]/','',(string)$s)); } }\nif (!function_exists('vh_raw'))        { function vh_raw($s){ return strtoupper(trim((string)$s)); } }\nif (!function_exists('vh_extract'))    { function vh_extract($s){ $u=strtoupper((string)$s); if(preg_match('/[A-Z0-9]+/',$u,$m)) return $m[0]; return vh_norm($u); } }\nif (!function_exists('vh_inlist'))     {\n  function vh_inlist($arr){\n    if(!$arr) return \"('')\";\n    $vals = array_map(fn($v)=>\"'\".addslashes($v).\"'\", array_values($arr));\n    return \"(\".implode(\",\", $vals).\")\";\n  }\n}\n\n//////////////////////////// Inputs ////////////////////////////\n$vehRaw  = trim((string)vh_param('veh',''));\n$hasSearch = ($vehRaw !== '');\n$pg      = (int)vh_param('pg',1); if($pg<1) $pg=1;\n$perPage = 15;\n$offset  = ($pg-1)*$perPage;\n\n//////////////////////////// Prepare data only IF searched ////////////////////////////\n$list = []; $totalRows=0; $totalPages=1; $crewByWork=[]; $partsByWork=[]; $json='[]';\n\nif ($hasSearch) {\n  // Filter (vehNo + chassis, raw + normalized)\n  $vehNorm = vh_norm($vehRaw);\n  $strip = \"REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(UPPER(%s), '-', ''), ' ', ''), '/', ''), '.', ''), '_', ''), ':', ''), '\\t','')\";\n  $vehEsc     = addslashes($vehRaw);\n  $vehNormEsc = addslashes($vehNorm);\n  $vehNoStripped  = sprintf($strip,\"COALESCE(mw.vehNo,'')\");\n  $chasStripped   = sprintf($strip,\"COALESCE(mw.chasisNo,'')\");\n  $where = \"\n    WHERE\n      UPPER(COALESCE(mw.vehNo,'')) LIKE UPPER('%{$vehEsc}%')\n      OR {$vehNoStripped} LIKE '%{$vehNormEsc}%'\n      OR {$chasStripped}  LIKE '%{$vehNormEsc}%'\n  \";\n\n  // Count\n  $row = vh_one(\"\n    SELECT COUNT(*) AS cnt\n    FROM mentain_workshop mw\n    INNER JOIN stations s ON s.STATION = mw.Station\n    INNER JOIN regions  r ON r.REGION_ID = s.REGION_ID\n    $where\n  \");\n  $totalRows  = (int)($row['cnt'] ?? 0);\n  $totalPages = max(1,(int)ceil($totalRows/$perPage));\n  if($pg>$totalPages){ $pg=$totalPages; $offset=($pg-1)*$perPage; }\n\n  // Page Results\n  $list = vh_all(\"\n    SELECT\n      mw.reqID AS work_id,\n      mw.Station, mw.vehNo, mw.servicetype, mw.description, mw.KMR,\n      mw.requestedby, mw.requestedon, mw.arrivaltime, mw.arrivaldate,\n      mw.vehType, mw.chasisNo, mw.repairInstruction, mw.KMRin, mw.KMRout,\n      mw.WOreqBy, mw.WOreqOn, mw.status,\n      mw.workorder_id, mw.workDate, mw.partsUsed, mw.reccomendation, mw.submittedby, mw.submittedOn,\n      CASE\n        WHEN mw.submittedOn IS NULL OR mw.submittedOn='' THEN DATEDIFF(CURDATE(), DATE(mw.WOreqOn))\n        ELSE DATEDIFF(DATE(mw.submittedOn), DATE(mw.WOreqOn))\n      END AS total_days_at_wkshop,\n      s.REGION_ID, r.REGION\n    FROM mentain_workshop mw\n    INNER JOIN stations s ON s.STATION   = mw.Station\n    INNER JOIN regions  r ON r.REGION_ID = s.REGION_ID\n    $where\n    ORDER BY mw.reqID DESC\n    LIMIT $offset, $perPage\n  \");\n\n  // Prefetch crew\n  $workIds = array_map(fn($r)=>(int)$r['work_id'], $list);\n  if ($workIds){\n    $ids = implode(',', array_map('intval',$workIds));\n    $crewRows = vh_all(\"\n      SELECT  c.ID,\n              mw.reqID AS work_id,\n              c.work_id AS source_work_id,\n              c.staffID, c.wordDone,\n              sf.SURNAMES, sf.FIRSTNAMES, sf.`MIDDLE NAME` AS MIDDLENAME\n      FROM mentain_workshop mw\n      JOIN crew_workdone c\n        ON (c.work_id = mw.reqID OR c.work_id = mw.workorder_id)\n      LEFT JOIN `{$STAFF_DB}`.`stafff` sf\n        ON UPPER(TRIM(sf.username)) = UPPER(TRIM(c.staffID))\n      WHERE mw.reqID IN ($ids)\n      ORDER BY c.ID ASC\n    \");\n    foreach($crewRows as $cr){\n      $wid = (int)$cr['work_id'];\n      if(!isset($crewByWork[$wid])) $crewByWork[$wid]=[];\n      $full = trim(preg_replace('/\\s+/', ' ', ($cr['FIRSTNAMES']?:'').' '.($cr['MIDDLENAME']?:'').' '.($cr['SURNAMES']?:'')));\n      if($full==='') $full = (string)$cr['staffID'];\n      $crewByWork[$wid][] = [\n        'staffID'   => (string)$cr['staffID'],\n        'staffName' => $full,\n        'wordDone'  => (string)$cr['wordDone']\n      ];\n    }\n  }\n\n  // Prefetch parts + names\n  $partsByWork = []; $productCodesAll=[];\n  if (!empty($workIds)){\n    $ids = implode(',', array_map('intval',$workIds));\n    $partRows = vh_all(\"\n      SELECT  p.ID,\n              mw.reqID AS work_id,\n              p.work_id AS source_work_id,\n              p.sparePart AS product_id,\n              p.quantity\n      FROM mentain_workshop mw\n      JOIN parts_used p\n        ON (p.work_id = mw.reqID OR p.work_id = mw.workorder_id)\n      WHERE mw.reqID IN ($ids)\n      ORDER BY p.ID ASC\n    \");\n    foreach($partRows as $pr){\n      $wid = (int)$pr['work_id'];\n      if(!isset($partsByWork[$wid])) $partsByWork[$wid]=[];\n      $pid = trim((string)$pr['product_id']);\n      $partsByWork[$wid][] = [\n        'product_id' => $pid,\n        'prod_name'  => '',\n        'quantity'   => (string)$pr['quantity'] === '' ? null : (int)$pr['quantity']\n      ];\n      if($pid!=='') $productCodesAll[] = $pid;\n    }\n\n    foreach ($list as $rec){\n      $wid = (int)$rec['work_id'];\n      if (!isset($partsByWork[$wid]) || !count($partsByWork[$wid])){\n        $raw = (string)$rec['partsUsed'];\n        if ($raw !== ''){\n          $tokens = preg_split('/[,\\;\\s]+/', $raw, -1, PREG_SPLIT_NO_EMPTY);\n          $seen = [];\n          foreach ($tokens as $t){\n            $code = trim($t);\n            if ($code==='') continue;\n            $base = vh_extract($code);\n            if (isset($seen[$base])) continue; $seen[$base] = true;\n            if(!isset($partsByWork[$wid])) $partsByWork[$wid]=[];\n            $partsByWork[$wid][] = [\n              'product_id' => $code,\n              'prod_name'  => '',\n              'quantity'   => null\n            ];\n            $productCodesAll[] = $code;\n          }\n        }\n      }\n    }\n\n    $rawSet  = []; $normSet = [];\n    foreach ($productCodesAll as $c){ $rawSet[vh_raw($c)] = true; $normSet[vh_norm($c)] = true; }\n    $inRaw  = vh_inlist(array_keys($rawSet));\n    $inNorm = vh_inlist(array_keys($normSet));\n\n    $mapRows = vh_all(\"\n      SELECT\n        product AS product_id_raw,\n        UPPER(TRIM(product)) AS key_raw,\n        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(UPPER(product),'-',''),' ',''),'/', ''),'.',''),'_',''),':','') AS key_norm,\n        MAX(prod_name) AS product_name\n      FROM `{$STORES_DB}`.`stock_bal_region`\n      WHERE UPPER(TRIM(product)) IN $inRaw\n         OR REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(UPPER(product),'-',''),' ',''),'/', ''),'.',''),'_',''),':','') IN $inNorm\n      GROUP BY product_id_raw, key_raw, key_norm\n    \");\n\n    $nameByRaw  = []; $nameByNorm = [];\n    foreach ($mapRows as $mr){\n      $nm = (string)$mr['product_name'];\n      $rawKey  = strtoupper(trim((string)$mr['key_raw']));\n      $normKey = strtoupper(trim((string)$mr['key_norm']));\n      if ($rawKey  !== '') $nameByRaw[$rawKey]   = $nm;\n      if ($normKey !== '') $nameByNorm[$normKey] = $nm;\n    }\n\n    foreach ($partsByWork as $wid => $arr){\n      foreach ($arr as $i => $p){\n        $raw  = vh_raw($p['product_id']);\n        $norm = vh_norm($p['product_id']);\n        $nm = $nameByRaw[$raw] ?? ($nameByNorm[$norm] ?? '');\n        $partsByWork[$wid][$i]['prod_name'] = ($nm !== '') ? $nm : $p['product_id'];\n      }\n    }\n  }\n\n  // JSON payload for modal\n  $payload = [];\n  foreach($list as $r){\n    $wid = (int)$r['work_id'];\n    $arrivalTxt = trim(($r['arrivaldate'] ? vh_d($r['arrivaldate']) : 'â€”').' '.($r['arrivaltime'] ?: ''));\n    $payload[] = [\n      'work_id'      => $wid,\n      'Station'      => (string)$r['Station'],\n      'REGION'       => (string)$r['REGION'],\n      'vehNo'        => (string)$r['vehNo'],\n      'vehType'      => (string)$r['vehType'],\n      'servicetype'  => (string)$r['servicetype'],\n      'description'  => (string)$r['description'],\n      'KMR'          => (string)$r['KMR'],\n      'requestedon'  => (string)vh_dt($r['requestedon']),\n      'requestedby'  => (string)$r['requestedby'],\n      'WOreqOn'      => (string)vh_dt($r['WOreqOn']),\n      'WOreqBy'      => (string)$r['WOreqBy'],\n      'arrival'      => (string)$arrivalTxt,\n      'chasisNo'     => (string)$r['chasisNo'],\n      'repairInstruction' => (string)$r['repairInstruction'],\n      'KMRin'        => (string)$r['KMRin'],\n      'KMRout'       => (string)$r['KMRout'],\n      'status_code'  => (int)$r['status'],\n      'status_text'  => vh_statusText($r['status']),\n      'status_class' => vh_statusClass($r['status']),\n      'workorder_id' => (string)$r['workorder_id'],\n      'workDate'     => (string)vh_d($r['workDate']),\n      'partsUsed'    => (string)$r['partsUsed'],\n      'reccomendation'=> (string)$r['reccomendation'],\n      'submittedby'  => (string)$r['submittedby'],\n      'submittedOn'  => (string)vh_dt($r['submittedOn']),\n      'total_days_at_wkshop' => (int)max(0,(int)$r['total_days_at_wkshop']),\n      'crew'         => $crewByWork[$wid]  ?? [],\n      'parts'        => $partsByWork[$wid] ?? []\n    ];\n  }\n  $json = json_encode($payload, JSON_HEX_TAG|JSON_HEX_AMP|JSON_HEX_APOS|JSON_HEX_QUOT);\n}\n\n//////////////////////////// Table rows (only if searched) ////////////////////////////\n$rowsHtml = '';\nif ($hasSearch) {\n  if(!$list){\n    $rowsHtml .= '<tr><td colspan=\"9\" class=\"vh-muted\" style=\"text-align:center; padding:16px;\">No work orders found.</td></tr>';\n  } else {\n    foreach($list as $r){\n      $wid = (int)$r['work_id'];\n      $rowsHtml .= '<tr>';\n      $rowsHtml .= '<td>'.vh_i($wid).'</td>';\n      $rowsHtml .= '<td>'.vh_h($r['vehNo']).'</td>';\n      $rowsHtml .= '<td>'.vh_h($r['Station']).'</td>';\n      $rowsHtml .= '<td>'.vh_h($r['REGION']).'</td>';\n      $rowsHtml .= '<td>'.vh_h($r['servicetype']).'</td>';\n      $rowsHtml .= '<td>'.vh_dt($r['WOreqOn'] ?: $r['requestedon']).'</td>';\n      $rowsHtml .= '<td>'.vh_h(trim(($r['arrivaldate']?vh_d($r['arrivaldate']):'â€”').' '.($r['arrivaltime']?:''))).'</td>';\n      $rowsHtml .= '<td><span class=\"pill '.vh_statusClass($r['status']).'\">'.vh_h(vh_statusText($r['status'])).'</span></td>';\n      $rowsHtml .= '<td class=\"vh-actions\"><button type=\"button\" class=\"vh-btn\" onclick=\"openWorkModal('.$wid.')\">View</button></td>';\n      $rowsHtml .= '</tr>';\n    }\n  }\n}\n\n//////////////////////////// Output ////////////////////////////\necho <<<'HTML'\n<style>\n  .vh-wrap { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:18px; }\n  .vh-title { margin:0 0 10px; }\n  .vh-bar { display:flex; gap:8px; align-items:center; margin:0 0 12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; }\n  .vh-input-wrap{ position:relative; flex:1; }\n  .vh-input { width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; outline:none; }\n  .vh-btn { padding:10px 14px; border-radius:10px; border:1px solid #d0d7de; background:#f6f8fa; cursor:pointer; }\n  .vh-btn.primary { background:#0ea5e9; color:#fff; border-color:#0284c7; }\n\n  .vh-panel { border:1px solid #e5e7eb; border-radius:14px; background:#fff; padding:12px; }\n  .vh-count { color:#6b7280; font-size:13px; margin-bottom:10px; }\n\n  table.vh { width:100%; border-collapse:collapse; font-size:14px; }\n  table.vh th, table.vh td { padding:10px 12px; border-bottom:1px solid #f1f5f9; }\n  table.vh thead th { background:#f9fafb; border-bottom:1px solid #e5e7eb; font-weight:600; text-align:left; }\n\n  .pill { display:inline-block; padding:.25rem .6rem; border-radius:999px; font-size:.85rem; font-weight:700; border:1px solid transparent; }\n  .pill.ok   { background:#e6f4ea; color:#0f5132; border-color:#badbcc; }\n  .pill.warn { background:#fff3cd; color:#8a6d3b; border-color:#ffe69c; }\n  .pill.bad  { background:#fee2e2; color:#991b1b; border-color:#fecaca; }\n\n  .vh-actions .vh-btn { padding:6px 10px; }\n  .vh-pagination { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; font-size:13px; }\n\n  /* Autocomplete */\n  .vh-ac-list { position:absolute; top:100%; left:0; right:0; z-index:9998; background:#fff; border:1px solid #e5e7eb; border-radius:10px; margin-top:4px; box-shadow:0 6px 20px rgba(0,0,0,.08); display:none; max-height:240px; overflow:auto; }\n  .vh-ac-item { padding:8px 10px; cursor:pointer; }\n  .vh-ac-item:hover, .vh-ac-item.active { background:#f1f5f9; }\n\n  /* Empty-state card */\n  .vh-empty { border:1px dashed #d1d5db; background:#fafafa; border-radius:12px; padding:24px; text-align:center; color:#6b7280; }\n\n  /* Modal */\n  .vh-modal-mask { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; }\n  .vh-modal { background:#f7fafc; width:min(1100px, 96vw); max-height:92vh; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden; display:flex; flex-direction:column; }\n  .vh-modal-hd { padding:12px 16px; background:#0ea5e9; color:#fff; display:flex; align-items:center; justify-content:space-between; }\n  .vh-modal-bd { padding:16px; overflow:auto; }\n  .sec { border:1px solid #cbd5e1; background:#fff; border-radius:10px; margin-bottom:12px; }\n  .sec-hd { padding:8px 12px; background:#e2e8f0; color:#111827; font-weight:700; border-bottom:1px solid #cbd5e1; }\n  .sec-bd { padding:12px; }\n  .grid-2 { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px 16px; }\n  .fld .lbl { font-size:12px; color:#6b7280; }\n  .fld .val { font-weight:600; }\n  .subtable { margin-top:8px; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; }\n  .subtable table { width:100%; border-collapse:collapse; font-size:13px; }\n  .subtable th, .subtable td { padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; }\n  .subtable thead th { background:#f9fafb; }\n\n/* PERMANENT: remove the ghost grid/stripes under the results table */\n.vh-wrap table:not(.vh),\n.vh-wrap table:not(.vh) * {\n  display: none !important;\n  border: 0 !important;\n  background: transparent !important;\n  box-shadow: none !important;\n}\n\n/* belts & braces for common PHPRunner grid classes */\n.vh-wrap .bs-grid,\n.vh-wrap .rnr-grid,\n.vh-wrap .rnr-gridtable,\n.vh-wrap .grid,\n.vh-wrap .grid-scroll {\n  display: none !important;\n}\n/* Make the modal Close button visible on the blue header */\n.vh-modal-hd .vh-btn{\n  background: rgba(255,255,255,.14) !important;   /* subtle translucent light */\n  color: #fff !important;\n  border: 1px solid rgba(255,255,255,.6) !important;\n  border-radius: 10px;\n  font-weight: 600;\n}\n.vh-modal-hd .vh-btn:hover{\n  background: rgba(255,255,255,.24) !important;\n}\n.vh-modal-hd .vh-btn:active{\n  background: rgba(255,255,255,.34) !important;\n}\n.vh-modal-hd .vh-btn:focus-visible{\n  outline: 2px solid #fff;\n  outline-offset: 2px;\n}\n\n</style>\n\n<div class=\"vh-wrap\">\n  <h1 class=\"vh-title\">ðŸ”Ž Vehicle Maintenance History </h1>\n\n  <form method=\"get\" action=\"\" class=\"vh-bar\" id=\"vh-search-form\" onsubmit=\"return true;\">\n    <div class=\"vh-input-wrap\">\n      <input type=\"text\" class=\"vh-input\" name=\"veh\" id=\"veh\" placeholder=\"Enter vehicle number e.g. GR 1234-21\" autocomplete=\"on\" />\n      <div id=\"vh-ac\" class=\"vh-ac-list\"></div>\n    </div>\n    <button class=\"vh-btn primary\" type=\"submit\">Search</button>\n    <button class=\"vh-btn\" type=\"button\" id=\"vh-clear\">Clear</button>\n  </form>\nHTML;\n\nif (!$hasSearch) {\n  // Empty state only\n  echo '\n  <div class=\"vh-empty\">\n    Start by typing at least <b>2 characters</b> of a vehicle number. Suggestions will appear below the search box.\n  </div>';\n} else {\n  // Results panel\n  echo '\n  <div class=\"vh-panel\">\n    <div class=\"vh-count\" id=\"vh-count\"></div>\n    <div style=\"overflow:auto;\">\n      <table class=\"vh\">\n        <thead>\n          <tr>\n            <th>Work ID</th>\n            <th>Vehicle</th>\n            <th>Station</th>\n            <th>Region</th>\n            <th>Service Type</th>\n            <th>WO Requested On</th>\n            <th>Arrival Date/Time</th>\n            <th>Status</th>\n            <th>Actions</th>\n          </tr>\n        </thead>\n        <tbody id=\"vh-body\">';\n  echo $rowsHtml;\n  echo '\n        </tbody>\n      </table>\n    </div>';\n\n  // Pagination\n  $qsVeh = 'veh='.rawurlencode($vehRaw);\n  echo '<div class=\"vh-pagination\">';\n  echo '<span>Page '.vh_i($pg).' of '.vh_i($totalPages).'</span>';\n  if ($pg > 1){\n    echo '<a class=\"vh-btn\" href=\"?'.$qsVeh.'&pg=1\">Â« First</a>';\n    echo '<a class=\"vh-btn\" href=\"?'.$qsVeh.'&pg='.($pg-1).'\">â€¹ Prev</a>';\n  } else {\n    echo '<span class=\"vh-btn\" style=\"opacity:.5;\">Â« First</span><span class=\"vh-btn\" style=\"opacity:.5;\">â€¹ Prev</span>';\n  }\n  if ($pg < $totalPages){\n    echo '<a class=\"vh-btn\" href=\"?'.$qsVeh.'&pg='.($pg+1).'\">Next â€º</a>';\n    echo '<a class=\"vh-btn\" href=\"?'.$qsVeh.'&pg='.$totalPages.'\">Last Â»</a>';\n  } else {\n    echo '<span class=\"vh-btn\" style=\"opacity:.5;\">Next â€º</span><span class=\"vh-btn\" style=\"opacity:.5;\">Last Â»</span>';\n  }\n  echo '</div></div>';\n\n  // Modal container\n  echo '\n  <div class=\"vh-modal-mask\" id=\"vh-modal-mask\">\n    <div class=\"vh-modal\">\n      <div class=\"vh-modal-hd\">\n        <div id=\"vh-modal-title\" style=\"font-weight:700;\">Work Details</div>\n        <button type=\"button\" class=\"vh-btn\" onclick=\"closeWorkModal()\">Close âœ•</button>\n      </div>\n      <div class=\"vh-modal-bd\" id=\"vh-modal-body\"></div>\n    </div>\n  </div>';\n\n  // JSON only if searched\n  echo '<script id=\"work-data\" type=\"application/json\">'.$json.'</script>';\n}\n\necho <<<'HTML'\n<script>\n(function(){\n  var vehVal = (new URLSearchParams(location.search)).get('veh') || '';\n  var vehInput = document.getElementById('veh'); if(vehInput) vehInput.value = vehVal;\n\n  // Count summary (only if results exist in DOM)\n  var countEl = document.getElementById('vh-count');\n  if(countEl){\n    var rowsOnPage = document.querySelectorAll('#vh-body tr').length;\n    countEl.innerHTML = (vehVal ? 'Results for <b>'+escapeHtml(vehVal)+'</b>: ' : '') + rowsOnPage + ' record(s) on this page';\n  }\n\n  // Modal helpers only if dataset is present\n  var dataTag = document.getElementById('work-data');\n  var workDetails = [];\n  if(dataTag){\n    try { workDetails = JSON.parse(dataTag.textContent || '[]'); } catch(e){ workDetails = []; }\n  }\n\n  window.openWorkModal = function(id){\n    if(!workDetails.length) return;\n    id = Number(id);\n    var d = workDetails.find(function(x){ return Number(x.work_id)===id; });\n    if(!d) return;\n\n    document.getElementById('vh-modal-title').textContent = 'Work Details â€” #'+id;\n\n    var sec1 = section('SERVICE REQUEST DETAILS', grid2([\n      fld('Station', d.Station),          fld('Region', d.REGION),\n      fld('Veh No', d.vehNo),             fld('Veh Type', d.vehType),\n      fld('Servicetype', d.servicetype),  fld('Description', d.description),\n      fld('KMR', d.KMR),                  null,\n      fld('Requestedon', d.requestedon),  fld('Requestedby', d.requestedby)\n    ]));\n\n    var sec2 = section('WORK ORDER DETAILS', grid2([\n      fld('Arrivaldate', d.arrival),          fld('Chasis No', d.chasisNo),\n      fld('Repair Instruction', d.repairInstruction), fld('W Oreq On', d.WOreqOn),\n      fld('Workorder Id', d.workorder_id),    fld('W Oreq By', d.WOreqBy)\n    ]));\n\n    var sec3 = section('ACTUAL WORK DONE', grid2([\n      fld('Work Date', d.workDate),           fld('Parts Used', d.partsUsed),\n      fld('Work Done', d.reccomendation),     fld('Submittedby', d.submittedby),\n      fld('Submitted On', d.submittedOn),     fld('Total Days at Workshop', String(d.total_days_at_wkshop))\n    ]));\n\n    var crewRows = (d.crew||[]).map(function(c){\n      return '<tr><td>'+escapeHtml(c.staffName||\"\")+'</td><td>'+escapeHtml(c.staffID||\"\")+'</td><td>'+escapeHtml(c.wordDone||\"\")+'</td></tr>';\n    }).join('') || '<tr><td colspan=\"3\" class=\"vh-muted\">No crew recorded.</td></tr>';\n\n    var partsRows = (d.parts||[]).map(function(p){\n      var qty = (p.quantity==null || p.quantity===undefined || p.quantity==='') ? '-' : String(p.quantity);\n      return '<tr><td>'+escapeHtml(p.prod_name||\"\")+'</td><td>'+escapeHtml(p.product_id||\"\")+'</td><td>'+escapeHtml(qty)+'</td></tr>';\n    }).join('') || '<tr><td colspan=\"3\" class=\"vh-muted\">No spare parts recorded.</td></tr>';\n\n   var sec4 = section('CREW THAT WORKED ON THE VEHICLE ',\n  '<div class=\"subtable\"><table class=\"vh\"><thead><tr><th>Name</th><th>Staff ID</th><th>Work Done</th></tr></thead><tbody>'+crewRows+'</tbody></table></div>'\n);\n\nvar sec5 = section('SPARE PARTS/CONSUMABLES USED ',\n  '<div class=\"subtable\"><table class=\"vh\"><thead><tr><th>Spare Part</th><th>Product ID</th><th>Qty</th></tr></thead><tbody>'+partsRows+'</tbody></table></div>'\n);\n\n\n    document.getElementById('vh-modal-body').innerHTML = sec1 + sec2 + sec3 + sec4 + sec5;\n    document.getElementById('vh-modal-mask').style.display = 'flex';\n  };\n  window.closeWorkModal = function(){ document.getElementById('vh-modal-mask').style.display = 'none'; };\n\n  function section(title, bodyHtml){\n    return '<div class=\"sec\"><div class=\"sec-hd\">'+escapeHtml(title)+'</div><div class=\"sec-bd\">'+bodyHtml+'</div></div>';\n  }\n  function grid2(arr){\n    var cells = arr.map(function(x){\n      if(!x) return '<div></div>';\n      return '<div class=\"fld\"><div class=\"lbl\">'+escapeHtml(x.label)+'</div><div class=\"val\">'+escapeHtml(x.value||\"\")+'</div></div>';\n    }).join('');\n    return '<div class=\"grid-2\">'+cells+'</div>';\n  }\n  function fld(label,value){ return {label:label, value:value}; }\n  function escapeHtml(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;'); }\n\n  // === Autocomplete ===\n  var acBox = document.getElementById('vh-ac');\n  var idx = -1, items = [];\n  function hideAC(){ if(acBox){ acBox.style.display='none'; acBox.innerHTML=''; } idx = -1; items=[]; }\n  function renderAC(list){\n    if(!acBox) return;\n    if(!list || !list.length){ hideAC(); return; }\n    acBox.innerHTML = list.map(function(x,i){\n      return '<div class=\"vh-ac-item'+(i===0?' active':'')+'\" data-val=\"'+escapeHtml(x.value)+'\">'+escapeHtml(x.label)+'</div>';\n    }).join('');\n    acBox.style.display='block';\n    items = Array.prototype.slice.call(acBox.querySelectorAll('.vh-ac-item'));\n    idx = 0;\n    items.forEach(function(it){\n      it.addEventListener('mousedown', function(e){\n        e.preventDefault();\n        vehInput.value = it.getAttribute('data-val') || '';\n        hideAC();\n        document.getElementById('vh-search-form').submit();\n      });\n    });\n  }\n  function fetchAC(q){\n    var xhr = new XMLHttpRequest();\n    xhr.open('GET', '?ajax=veh_suggest&term='+encodeURIComponent(q));\n    xhr.onreadystatechange = function(){\n      if(xhr.readyState===4 && xhr.status===200){\n        try{ renderAC(JSON.parse(xhr.responseText)); }catch(_){ hideAC(); }\n      }\n    };\n    xhr.send();\n  }\n\n  if(vehInput){\n    vehInput.addEventListener('input', function(){\n      var v = vehInput.value.trim();\n      if(v.length < 2){ hideAC(); return; }\n      fetchAC(v);\n    });\n    vehInput.addEventListener('keydown', function(e){\n      if(!acBox || acBox.style.display!=='block') return;\n      if(e.key==='ArrowDown'){ e.preventDefault(); idx=Math.min(idx+1, items.length-1); updateActive(); }\n      else if(e.key==='ArrowUp'){ e.preventDefault(); idx=Math.max(idx-1, 0); updateActive(); }\n      else if(e.key==='Enter'){ if(idx>=0 && items[idx]){ e.preventDefault(); vehInput.value = items[idx].getAttribute('data-val')||''; hideAC(); document.getElementById('vh-search-form').submit(); } }\n      else if(e.key==='Escape'){ hideAC(); }\n    });\n    document.addEventListener('click', function(e){ if(acBox && !acBox.contains(e.target) && e.target!==vehInput) hideAC(); });\n  }\n  function updateActive(){\n    items.forEach(function(it,i){ if(i===idx) it.classList.add('active'); else it.classList.remove('active'); });\n    if(idx>=0 && items[idx]) items[idx].scrollIntoView({block:'nearest'});\n  }\n\n  // Clear button\n  var clearBtn = document.getElementById('vh-clear');\n  if(clearBtn){\n    clearBtn.addEventListener('click', function(){\n      if(vehInput) vehInput.value='';\n      hideAC();\n      window.location.href = window.location.pathname; // same page, no params => shows only the empty state\n    });\n  }\n})();\n</script>\nHTML;\n"
}