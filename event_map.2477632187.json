{
	"name": "map",
	"serverCode": "/* Ghana Commission Map ‚Äî shapeName matching (brace-safe version)\n   Requirements:\n   - GeoJSON at include/ghana_regions.geojson with property 'shapeName' per region\n   - Tables: regions(REGION_ID, REGION, region_name), stations, mentain_workshop\n*/\n\n//////////////////// Helpers ////////////////////\nfunction q_fetchAll($sql){\n  $out=[]; $rs = DB::Query($sql);\n  while($rs && ($r=$rs->fetchAssoc())) $out[] = $r;\n  return $out;\n}\nfunction q_json($v){ return json_encode($v, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES); }\n\n// Normalizer: UPPER ‚Üí strip punctuation & ‚ÄúREGION‚Äù ‚Üí strip spaces ‚Üí letters only\nfunction norm_key($s){\n  $u = strtoupper((string)$s);\n  $u = str_replace(['&','/','\\\\','.','-','_'], ' ', $u);\n  $u = preg_replace('/\\bREGION\\b/', '', $u);\n  $u = preg_replace('/\\s+/', '', $u);\n  return preg_replace('/[^A-Z]/', '', $u);\n}\n\n//////////////////// Regions (DB) ////////////////////\n$regRows = q_fetchAll(\"\n  SELECT REGION_ID,\n         COALESCE(NULLIF(TRIM(region_name),''), NULLIF(TRIM(REGION),''), CONCAT('Region ', REGION_ID)) AS region_name\n  FROM regions\n  GROUP BY REGION_ID\n  ORDER BY REGION_ID\n\");\n\n$ridToName = [];\n$keyToRid  = [];   // normalized name -> REGION_ID\nforeach($regRows as $r){\n  $rid  = (int)$r['REGION_ID'];\n  $name = (string)$r['region_name'];\n  if($name==='') continue;\n  $ridToName[$rid] = $name;\n\n  // several keys for robustness\n  $k1 = norm_key($name);\n  $k2 = norm_key(str_replace('REGION','',$name));\n  $k3 = norm_key(str_replace(['GREATER','METROPOLITAN','MUNICIPAL','DISTRICT'], '', $name));\n  foreach(array_unique([$k1,$k2,$k3]) as $k){\n    if($k!=='') $keyToRid[$k] = $rid;\n  }\n}\n\n// manual aliases for common Ghana variants\n$aliases = [\n  'GREATERACCRA' => 'GREATERACCRA',\n  'ASHANTI'      => 'ASHANTI',\n  'EASTERN'      => 'EASTERN',\n  'CENTRAL'      => 'CENTRAL',\n  'WESTERNNORTH' => 'WESTERNNORTH',\n  'WESTERN'      => 'WESTERN',\n  'NORTHERN'     => 'NORTHERN',\n  'NORTHEAST'    => 'NORTHEAST',\n  'SAVANNAH'     => 'SAVANNAH',\n  'UPPEREAST'    => 'UPPEREAST',\n  'UPPERWEST'    => 'UPPERWEST',\n  'BONO'         => 'BONO',\n  'BONOEAST'     => 'BONOEAST',\n  'AHAFO'        => 'AHAFO',\n  'OTI'          => 'OTI',\n  'VOLTA'        => 'VOLTA',\n];\nforeach($aliases as $alias=>$target){\n  if(isset($keyToRid[$target])) $keyToRid[$alias] = $keyToRid[$target];\n}\n\n//////////////////// Stations snapshot ////////////////////\n$rows = q_fetchAll(\"\n  SELECT s.REGION_ID, s.STATION, s.VehicleNo, s.Avail, s.gps,\n         CASE\n           WHEN s.VehicleNo IS NULL OR s.VehicleNo='' THEN 1\n           WHEN EXISTS (SELECT 1 FROM mentain_workshop w WHERE w.Station=s.STATION AND w.status=3 LIMIT 1) THEN 1\n           ELSE 0\n         END AS is_ooc,\n         CASE\n           WHEN s.VehicleNo IS NULL OR s.VehicleNo='' THEN 'No Vehicle'\n           WHEN EXISTS (SELECT 1 FROM mentain_workshop w2 WHERE w2.Station=s.STATION AND w2.status=3 LIMIT 1) THEN 'In Workshop'\n           ELSE 'Working'\n         END AS ooc_reason\n  FROM stations s\n  WHERE UPPER(TRIM(COALESCE(s.OfficeType,'')))='STATION'\n\");\n\n$byRid = []; // rid => stats\nforeach($rows as $r){\n  $rid = (int)$r['REGION_ID'];\n  if(!isset($byRid[$rid])){\n    $byRid[$rid] = [\n      'rid'      => $rid,\n      'name'     => $ridToName[$rid] ?? ('Region '.$rid),\n      'total'    => 0,\n      'working'  => 0,\n      'ooc'      => 0,\n      'stations' => []\n    ];\n  }\n  $byRid[$rid]['total']++;\n  if(((int)$r['is_ooc'])===1) $byRid[$rid]['ooc']++; else $byRid[$rid]['working']++;\n  $byRid[$rid]['stations'][] = [\n    'station' => (string)$r['STATION'],\n    'vehicle' => (string)$r['VehicleNo'],\n    'avail'   => (string)$r['Avail'],\n    'gps'     => (string)$r['gps'],\n    'status'  => (string)$r['ooc_reason']\n  ];\n}\n\n// build name-keyed stats (for matching shapeName)\n$nameStats = [];       // normName => stats\nforeach($byRid as $rid=>$st){\n  $k = norm_key($st['name']);\n  $total = max(0,(int)$st['total']);\n  $w     = (int)$st['working'];\n  $pctW  = $total>0 ? round(($w/$total)*100,1) : 0.0;\n  $nameStats[$k] = [\n    'region_id'   => $rid,\n    'name'        => $st['name'],\n    'total'       => $total,\n    'working'     => $w,\n    'ooc'         => (int)$st['ooc'],\n    'pct_working' => $pctW,\n    'pct_ooc'     => round(100 - $pctW, 1),\n    'stations'    => $st['stations']\n  ];\n}\n\n// ship to JS\n$JS_NAMESTATS = q_json($nameStats);\n?>\n<style>\n  .gh-map-wrap{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px;}\n  .gh-title{margin:0 0 10px;font-size:20px;font-weight:800;display:flex;align-items:center;gap:8px}\n  .gh-panel{display:grid;grid-template-columns:minmax(280px,1fr) 420px;gap:14px}\n  @media(max-width:1100px){.gh-panel{grid-template-columns:1fr}}\n  #ghanaMap{height:560px;border:1px solid #e5e7eb;border-radius:12px}\n  .gh-side{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px}\n  .gh-legend{display:flex;align-items:center;gap:8px;margin:8px 0 12px}\n  .gh-swatch{width:20px;height:12px;border-radius:2px;border:1px solid rgba(0,0,0,.15)}\n  .gh-row{display:flex;justify-content:space-between;gap:12px;padding:6px 0;border-bottom:1px dashed #eef2f7}\n  .gh-row:last-child{border-bottom:0}\n  .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.8rem;font-weight:700;border:1px solid transparent}\n  .pill-ok{background:#e6f4ea;color:#0f5132;border-color:#badbcc}\n  .pill-bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}\n  .gh-note{color:#6b7280;font-size:12px}\n  .leaflet-tooltip{font-weight:600}\n</style>\n\n<div class=\"gh-map-wrap\">\n  <h3 class=\"gh-title\">üó∫Ô∏è Ghana ‚Äî Stations Commission Status by Region</h3>\n  <div class=\"gh-panel\">\n    <div id=\"ghanaMap\"></div>\n    <div class=\"gh-side\" id=\"infoPanel\">\n      <div class=\"gh-legend\"><span class=\"gh-swatch\" style=\"background:#a50f15\"></span><small>&le; 40% in-commission</small></div>\n      <div class=\"gh-legend\"><span class=\"gh-swatch\" style=\"background:#f16913\"></span><small>~ 60% in-commission</small></div>\n      <div class=\"gh-legend\"><span class=\"gh-swatch\" style=\"background:#31a354\"></span><small>&ge; 85% in-commission</small></div>\n      <div class=\"gh-row\"><span>Selected Region</span><strong id=\"selName\">‚Äî</strong></div>\n      <div class=\"gh-row\"><span>Working</span><span><span class=\"pill pill-ok\" id=\"selWorking\">0</span></span></div>\n      <div class=\"gh-row\"><span>Out of Commission</span><span><span class=\"pill pill-bad\" id=\"selOOC\">0</span></span></div>\n      <div class=\"gh-row\"><span>Total Stations</span><strong id=\"selTotal\">0</strong></div>\n      <div class=\"gh-row\"><span>In-Commission %</span><strong id=\"selPctW\">0%</strong></div>\n      <div class=\"gh-row\"><span>OOC %</span><strong id=\"selPctO\">0%</strong></div>\n      <p class=\"gh-note\" style=\"margin-top:10px\">Hover to preview, click to lock. Data reflects current station &amp; workshop state.</p>\n      <div id=\"selList\" style=\"margin-top:10px;max-height:250px;overflow:auto;font-size:13px\"></div>\n    </div>\n  </div>\n</div>\n\n<script src=\"https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js\" crossorigin=\"anonymous\"></script>\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css\" crossorigin=\"anonymous\"/>\n\n<script>\n(function(){\n  // ==== Data from PHP ====\n  const nameStats = <?php echo $JS_NAMESTATS; ?>;  // { normName: {name, pct_working, ...} }\n  const allKeys   = Object.keys(nameStats);\n\n  // Normalizer in JS (mirror of PHP norm_key)\n  function normName(s){\n    return String(s||'')\n      .toUpperCase()\n      .replace(/[&/\\\\.\\-_]/g,' ')\n      .replace(/\\bREGION\\b/g,'')\n      .replace(/\\s+/g,'')\n      .replace(/[^A-Z]/g,'');\n  }\n\n  // Tiny Levenshtein for fuzzy fallback (‚â§25% of length)\n  function lev(a,b){\n    const m=a.length,n=b.length;\n    if(!m) return n; if(!n) return m;\n    const dp=new Array(n+1);\n    for(let j=0;j<=n;j++) dp[j]=j;\n    for(let i=1;i<=m;i++){\n      let prev=dp[0], cur; dp[0]=i;\n      for(let j=1;j<=n;j++){\n        const tmp=dp[j];\n        cur=Math.min(dp[j]+1, dp[j-1]+1, prev+(a[i-1]===b[j-1]?0:1));\n        dp[j]=cur; prev=tmp;\n      }\n    }\n    return dp[n];\n  }\n  function closestKey(query){\n    const key = normName(query);\n    if(nameStats[key]) return key;\n    let best=null, bestDist=1e9;\n    for(const k of allKeys){\n      const d=lev(key,k);\n      if(d<bestDist){ best=k; bestDist=d; }\n    }\n    const maxAllowed = Math.ceil(Math.max(key.length,(best||'').length)*0.25);\n    return (bestDist<=maxAllowed) ? best : null;\n  }\n\n  // ==== Map ====\n  const map = L.map('ghanaMap',{zoomControl:true,attributionControl:false}).setView([7.95,-1.03],6);\n  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);\n\n  function colorFor(pct){\n    if(pct==null) return '#d9d9d9';\n    if(pct<40) return '#a50f15';\n    if(pct<60) return '#f16913';\n    if(pct<75) return '#f1c40f';\n    if(pct<85) return '#7fc97f';\n    return '#31a354';\n  }\n\n  const el = {\n    name: document.getElementById('selName'),\n    w:    document.getElementById('selWorking'),\n    o:    document.getElementById('selOOC'),\n    t:    document.getElementById('selTotal'),\n    pw:   document.getElementById('selPctW'),\n    po:   document.getElementById('selPctO'),\n    list: document.getElementById('selList')\n  };\n  function esc(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;')\n                   .replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;'); }\n  function setPanel(st){\n    if(!st){ el.name.textContent='‚Äî'; el.w.textContent='0'; el.o.textContent='0';\n             el.t.textContent='0'; el.pw.textContent='0%'; el.po.textContent='0%'; el.list.innerHTML=''; return; }\n    el.name.textContent = st.name||'‚Äî';\n    el.w.textContent    = String(st.working||0);\n    el.o.textContent    = String(st.ooc||0);\n    el.t.textContent    = String(st.total||0);\n    el.pw.textContent   = (st.pct_working!=null?Number(st.pct_working).toFixed(1):'0.0')+'%';\n    el.po.textContent   = (st.pct_ooc!=null?Number(st.pct_ooc).toFixed(1):'0.0')+'%';\n    el.list.innerHTML = (st.stations||[]).slice().sort((a,b)=>(a.station||'').localeCompare(b.station||''))\n      .map(s=>`<div style=\"padding:6px 0;border-bottom:1px solid #f5f5f5\">\n                 <div><b>${esc(s.station||'')}</b> ‚Äî <small>${esc(s.status||'')}</small></div>\n                 <div class=\"gh-note\">Vehicle: ${esc(s.vehicle||'‚Äî')} ¬∑ Avail: ${esc(s.avail||'')}</div>\n               </div>`).join('');\n  }\n\n  fetch('include/ghana_regions.geojson')\n    .then(r=>r.json())\n    .then(geo=>{\n      const layer = L.geoJSON(geo,{\n        style: f=>{\n          const nm = f.properties.shapeName || f.properties.ShapeName || f.properties.name || '';\n          let k = normName(nm);\n          if(!nameStats[k]) k = closestKey(nm) || k;\n          const st = nameStats[k] || null;\n          return {color:'#8e8e8e',weight:1,fillColor:colorFor(st?st.pct_working:null),fillOpacity:0.85};\n        },\n        onEachFeature: (feature, lyr)=>{\n          const nm = feature.properties.shapeName || feature.properties.ShapeName || feature.properties.name || '';\n          let k = normName(nm);\n          if(!nameStats[k]) k = closestKey(nm) || k;\n          const st = nameStats[k] || null;\n          const tip = st\n            ? `${esc(st.name)}<br>Working: <b>${st.working}</b> ¬∑ OOC: <b>${st.ooc}</b><br>In-Comm: <b>${st.pct_working}%</b> ¬∑ Total: <b>${st.total}</b>`\n            : `${esc(nm)}<br><i>No matching data</i>`;\n          lyr.bindTooltip(tip,{sticky:true});\n          lyr.on({\n            mouseover:e=>e.target.setStyle({weight:3}),\n            mouseout: e=>e.target.setStyle({weight:1}),\n            click:   e=>setPanel(st)\n          });\n        }\n      }).addTo(map);\n      try{ map.fitBounds(layer.getBounds(),{padding:[10,10]}); }catch(e){}\n    })\n    .catch(err=>console.error('GeoJSON load failed', err));\n})();\n</script>\n"
}