{
	"name": "Snippet",
	"serverCode": "/* Vehicle Maintenance & Commission Dashboard (PHPRunner Event - pure PHP)\n * - Year filter (All years = rolling last 12 months)\n * - Maintenance summary cards (filtered)\n * - Line chart: cumulative (as-at) Requested vs Completed + Outstanding\n * - Cross-tab: Vehicles × Months (Completed only), paginated (10 per page)\n * - Commission snapshot (STATION only): In-commission vs Out-of-commission with %\n * - NEW: Regional Work Orders table (Pending vs Completed + %), per region\n * - NEW: View Controls (checkboxes) to show/hide sections — keeps the UI clean\n * - Actions: “Stations in Commission” & “OOC Only” popup lists per region\n */\n\n//////////////// Helpers ////////////////\nfunction fetchOne($sql){ $rs = DB::Query($sql); return $rs ? $rs->fetchAssoc() : null; }\nfunction fmtInt($n){ return number_format((int)$n); }\nfunction fmtFloat($n,$d=1){ return number_format((float)$n,$d); }\nfunction h($s){ return htmlspecialchars((string)$s, ENT_QUOTES); }\nfunction pageLink($p,$yr){ return '?year='.rawurlencode($yr).'&page='.(int)$p; }\n\n//////////////// Inputs ////////////////\n$yearParam = isset($_GET['year']) ? trim($_GET['year']) : date('Y');\n$selYear   = (strtolower($yearParam)==='all'||$yearParam==='') ? 'all' : (int)$yearParam;\n\n$page = isset($_GET['page']) ? (int)$_GET['page'] : 1;\nif ($page < 1) $page = 1;\n$perPage = 10;\n$offset  = ($page-1)*$perPage;\n\n// Year clauses\n$yrWO  = ($selYear==='all') ? '' : ' AND YEAR(WOreqOn) = '.$selYear.' ';\n$yrSUB = ($selYear==='all') ? '' : ' AND YEAR(submittedOn) = '.$selYear.' ';\n\n//////////////// Years list ////////////////\n$years = [];\n$rsYears = DB::Query(\"\n  SELECT yr FROM (\n    SELECT DISTINCT YEAR(WOreqOn)     AS yr FROM mentain_workshop WHERE WOreqOn     IS NOT NULL\n    UNION\n    SELECT DISTINCT YEAR(submittedOn) AS yr FROM mentain_workshop WHERE submittedOn IS NOT NULL\n  ) y WHERE yr IS NOT NULL ORDER BY yr DESC\n\");\nwhile($row=$rsYears->fetchAssoc()){ $years[]=(int)$row['yr']; }\nif(!$years){ $years=[(int)date('Y')]; }\n\n//////////////// Maintenance Summary ////////////////\n// Total WOs (by request date)\n$row = fetchOne(\"SELECT COUNT(*) AS cnt FROM mentain_workshop WHERE 1=1 $yrWO\");\n$total_wo = (int)($row['cnt'] ?? 0);\n\n// Ongoing & Completed\n$row = fetchOne(\"\n  SELECT \n    SUM(CASE WHEN status=3 AND \".($selYear==='all'?\"1\":\"YEAR(WOreqOn)={$selYear}\").\" THEN 1 ELSE 0 END) AS ongoing,\n    SUM(CASE WHEN status=4 AND \".($selYear==='all'?\"1\":\"YEAR(submittedOn)={$selYear}\").\" THEN 1 ELSE 0 END) AS completed\n  FROM mentain_workshop\n\");\n$ongoing   = (int)($row['ongoing']   ?? 0);\n$completed = (int)($row['completed'] ?? 0);\n\n// Avg TAT (completed)\n$row = fetchOne(\"\n  SELECT AVG(DATEDIFF(DATE(submittedOn), DATE(WOreqOn))) AS avg_tat\n  FROM mentain_workshop\n  WHERE status=4 AND submittedOn IS NOT NULL AND WOreqOn IS NOT NULL $yrSUB\n\");\n$avg_tat = $row && $row['avg_tat']!==null ? round((float)$row['avg_tat'],1) : 0.0;\n\n// Pending & Overdue\n$row = fetchOne(\"\n  SELECT \n    COUNT(*) AS pending,\n    SUM(CASE WHEN WOreqOn IS NOT NULL AND DATEDIFF(CURDATE(), DATE(WOreqOn))>14 THEN 1 ELSE 0 END) AS overdue\n  FROM mentain_workshop\n  WHERE status=3 $yrWO\n\");\n$pending = (int)($row['pending'] ?? 0);\n$overdue = (int)($row['overdue'] ?? 0);\n\n// Top vehicle (completed)\n$row = fetchOne(\"\n  SELECT vehNo, COUNT(*) AS cnt\n  FROM mentain_workshop\n  WHERE status=4 AND submittedOn IS NOT NULL $yrSUB\n  GROUP BY vehNo ORDER BY cnt DESC, vehNo LIMIT 1\n\");\n$vehNo  = trim((string)($row['vehNo'] ?? ''));\n$vehCnt = (int)($row['cnt'] ?? 0);\n$top_vehicle = $vehNo ? h($vehNo).\" (\".$vehCnt.\" WOs)\" : \"—\";\n\n//////////////// Trend (cumulative) //////////////////\n$labels=[]; $reqMonthly=array_fill(0,12,0); $doneMonthly=array_fill(0,12,0);\n\nif($selYear==='all'){\n  $start = date('Y-m-01', strtotime('-11 months')); $end = date('Y-m-t');\n  $mapIndex=[];\n  for($i=0;$i<12;$i++){ $ts=strtotime(\"+$i month\",strtotime($start)); $labels[$i]=date('M Y',$ts); $mapIndex[date('Y-m',$ts)]=$i; }\n  $rs = DB::Query(\"\n    SELECT DATE_FORMAT(WOreqOn,'%Y-%m') ym, COUNT(*) cnt\n    FROM mentain_workshop\n    WHERE WOreqOn IS NOT NULL AND DATE(WOreqOn) BETWEEN '$start' AND '$end' GROUP BY ym\n  \");\n  while($r=$rs->fetchAssoc()){ if(isset($mapIndex[$r['ym']])) $reqMonthly[$mapIndex[$r['ym']]]=(int)$r['cnt']; }\n  $rs = DB::Query(\"\n    SELECT DATE_FORMAT(submittedOn,'%Y-%m') ym, COUNT(*) cnt\n    FROM mentain_workshop\n    WHERE status=4 AND submittedOn IS NOT NULL AND DATE(submittedOn) BETWEEN '$start' AND '$end' GROUP BY ym\n  \");\n  while($r=$rs->fetchAssoc()){ if(isset($mapIndex[$r['ym']])) $doneMonthly[$mapIndex[$r['ym']]]=(int)$r['cnt']; }\n  $trendTitle='Trend (Last 12 Months)';\n}else{\n  $labels=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];\n  $rs=DB::Query(\"SELECT MONTH(WOreqOn) m, COUNT(*) cnt FROM mentain_workshop WHERE WOreqOn IS NOT NULL AND YEAR(WOreqOn)={$selYear} GROUP BY m\");\n  while($r=$rs->fetchAssoc()){ $idx=max(0,min(11,(int)$r['m']-1)); $reqMonthly[$idx]=(int)$r['cnt']; }\n  $rs=DB::Query(\"SELECT MONTH(submittedOn) m, COUNT(*) cnt FROM mentain_workshop WHERE status=4 AND submittedOn IS NOT NULL AND YEAR(submittedOn)={$selYear} GROUP BY m\");\n  while($r=$rs->fetchAssoc()){ $idx=max(0,min(11,(int)$r['m']-1)); $doneMonthly[$idx]=(int)$r['cnt']; }\n  $trendTitle='Trend ('.$selYear.')';\n}\n$seriesTotal=[]; $seriesDone=[]; $seriesOut=[]; $runReq=0; $runDone=0;\nfor($i=0;$i<12;$i++){ $runReq+=$reqMonthly[$i]; $runDone+=$doneMonthly[$i]; $seriesTotal[$i]=$runReq; $seriesDone[$i]=$runDone; $seriesOut[$i]=max(0,$runReq-$runDone); }\n\n//////////////// Cross-tab: Vehicles × Months (Completed) //////////////////\n$yearClause = ($selYear==='all') ? '' : \" AND YEAR(submittedOn)=$selYear \";\n$row = fetchOne(\"\n  SELECT COUNT(*) AS cnt FROM (\n    SELECT vehNo FROM mentain_workshop WHERE status=4 AND submittedOn IS NOT NULL $yearClause GROUP BY vehNo\n  ) t\n\");\n$totalRows=(int)($row['cnt'] ?? 0);\n$totalPages=max(1,(int)ceil($totalRows/$perPage));\nif($page>$totalPages){ $page=$totalPages; $offset=($page-1)*$perPage; }\n\n$rs = DB::Query(\"\n  SELECT vehNo,\n    SUM(CASE WHEN MONTH(submittedOn)=1  THEN 1 ELSE 0 END) AS Jan,\n    SUM(CASE WHEN MONTH(submittedOn)=2  THEN 1 ELSE 0 END) AS Feb,\n    SUM(CASE WHEN MONTH(submittedOn)=3  THEN 1 ELSE 0 END) AS Mar,\n    SUM(CASE WHEN MONTH(submittedOn)=4  THEN 1 ELSE 0 END) AS Apr,\n    SUM(CASE WHEN MONTH(submittedOn)=5  THEN 1 ELSE 0 END) AS May,\n    SUM(CASE WHEN MONTH(submittedOn)=6  THEN 1 ELSE 0 END) AS Jun,\n    SUM(CASE WHEN MONTH(submittedOn)=7  THEN 1 ELSE 0 END) AS Jul,\n    SUM(CASE WHEN MONTH(submittedOn)=8  THEN 1 ELSE 0 END) AS Aug,\n    SUM(CASE WHEN MONTH(submittedOn)=9  THEN 1 ELSE 0 END) AS Sep,\n    SUM(CASE WHEN MONTH(submittedOn)=10 THEN 1 ELSE 0 END) AS Oct,\n    SUM(CASE WHEN MONTH(submittedOn)=11 THEN 1 ELSE 0 END) AS Nov,\n    SUM(CASE WHEN MONTH(submittedOn)=12 THEN 1 ELSE 0 END) AS `Dec`,\n    COUNT(*) AS Total\n  FROM mentain_workshop\n  WHERE status=4 AND submittedOn IS NOT NULL $yearClause\n  GROUP BY vehNo\n  ORDER BY Total DESC, vehNo\n  LIMIT $offset, $perPage\n\");\n$crosstabRows=[]; while($r=$rs->fetchAssoc()){ $crosstabRows[]=$r; }\n$qsYear = ($selYear==='all') ? 'all' : (string)$selYear;\n\n//////////////// Commission Snapshot (STATION only) //////////////////\n// Region names (REGION_ID => name)\n$regionNames=[];\n$rsR=DB::Query(\"\n  SELECT REGION_ID, MIN(COALESCE(NULLIF(TRIM(REGION),''), NULLIF(TRIM(region_name),''), CONCAT('Region ', REGION_ID))) AS region_name\n  FROM regions GROUP BY REGION_ID\n\");\nwhile($r=$rsR->fetchAssoc()){ $regionNames[(int)$r['REGION_ID']]=$r['region_name']; }\n\n// Stations + OOC rule\n$rsSt = DB::Query(\"\n  SELECT s.REGION_ID, s.STATION, s.VehicleNo, s.Avail, s.gps,\n    CASE\n      WHEN s.VehicleNo IS NULL OR s.VehicleNo='' THEN 1\n      WHEN EXISTS (SELECT 1 FROM mentain_workshop w WHERE w.Station=s.STATION AND w.status=3 LIMIT 1) THEN 1\n      ELSE 0\n    END AS is_ooc,\n    CASE\n      WHEN s.VehicleNo IS NULL OR s.VehicleNo='' THEN 'No Vehicle'\n      WHEN EXISTS (SELECT 1 FROM mentain_workshop w2 WHERE w2.Station=s.STATION AND w2.status=3 LIMIT 1) THEN 'In Workshop'\n      ELSE 'Working'\n    END AS ooc_reason\n  FROM stations s\n  WHERE UPPER(TRIM(COALESCE(s.OfficeType,'')))='STATION'\n\");\n$commRegionsStats=[]; $commStationsByReg=[]; $commTotStations=0; $commTotOOC=0; $commOOC_workshop=0; $commOOC_noveh=0;\nwhile($row=$rsSt->fetchAssoc()){\n  $rid=(int)$row['REGION_ID']; $rname=$regionNames[$rid] ?? ('Region '.$rid);\n  if(!isset($commRegionsStats[$rid])){ $commRegionsStats[$rid]=['name'=>$rname,'total'=>0,'working'=>0,'ooc'=>0]; $commStationsByReg[$rid]=[]; }\n  $is_ooc=((int)$row['is_ooc']===1);\n  $commRegionsStats[$rid]['total']++; $commTotStations++;\n  if($is_ooc){ $commRegionsStats[$rid]['ooc']++; $commTotOOC++; if($row['ooc_reason']==='In Workshop') $commOOC_workshop++; if($row['ooc_reason']==='No Vehicle') $commOOC_noveh++; }\n  $commStationsByReg[$rid][]=['station'=>$row['STATION'],'vehicle'=>$row['VehicleNo'],'gps'=>$row['gps'],'avail'=>$row['Avail'],'status'=>$row['ooc_reason'],'is_ooc'=>$is_ooc?1:0];\n}\nforeach($commRegionsStats as $rid=>$st){ $commRegionsStats[$rid]['working']=$st['total']-$st['ooc']; }\n$commTotWorking=$commTotStations-$commTotOOC;\n$commWorkPct = ($commTotStations>0) ? number_format(($commTotWorking/$commTotStations)*100,1) : 0;\n\n// JS data for commission table\n$jsCommRegions=[];\nforeach($commRegionsStats as $rid=>$st){\n  $jsCommRegions[]=[\n    'region_id'=>$rid,'name'=>$st['name'],'total'=>(int)$st['total'],'working'=>(int)$st['working'],'ooc'=>(int)$st['ooc'],\n    'work_rate'=>($st['total']>0?round(($st['working']/$st['total'])*100,1):0),\n    'ooc_rate' =>($st['total']>0?round(($st['ooc']    /$st['total'])*100,1):0)\n  ];\n}\n\n//////////////// NEW: Regional Work Orders table (Pending vs Completed) ////////////////\n// Define by request year (WOreqOn) so percentages use the same denominator\n$yrWOfilter = ($selYear==='all') ? '' : \" AND YEAR(w.WOreqOn)=$selYear \";\n$rsRW = DB::Query(\"\n  SELECT s.REGION_ID,\n         SUM(CASE WHEN w.status=3 THEN 1 ELSE 0 END) AS pending_wos,\n         SUM(CASE WHEN w.status=4 THEN 1 ELSE 0 END) AS completed_wos,\n         COUNT(*) AS total_wos\n  FROM stations s\n  JOIN mentain_workshop w ON w.Station = s.STATION\n  WHERE UPPER(TRIM(COALESCE(s.OfficeType,'')))='STATION'\n    AND w.WOreqOn IS NOT NULL\n    $yrWOfilter\n  GROUP BY s.REGION_ID\n\");\n$regionWOStats=[]; // [{region, pending, completed, total, pend_rate, comp_rate}]\nwhile($r=$rsRW->fetchAssoc()){\n  $rid=(int)$r['REGION_ID'];\n  $name=$regionNames[$rid] ?? ('Region '.$rid);\n  $pending_wos=(int)$r['pending_wos'];\n  $completed_wos=(int)$r['completed_wos'];\n  $total_wos=(int)$r['total_wos'];\n  $regionWOStats[]=[\n    'region'=>$name,\n    'pending'=>$pending_wos,\n    'completed'=>$completed_wos,\n    'total'=>$total_wos,\n    'pend_rate'=>($total_wos>0?round(($pending_wos/$total_wos)*100,1):0),\n    'comp_rate'=>($total_wos>0?round(($completed_wos/$total_wos)*100,1):0)\n  ];\n}\n// Sort alphabetically by region name\nusort($regionWOStats, function($a,$b){ return strcmp($a['region'],$b['region']); });\n\n//////////////// HTML ///////////////////\necho '\n<style>\n  /* Minimal modern styling */\n  .vmcd-wrap { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:20px; }\n  .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }\n  .toolbar .chip { display:flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; font-size:13px; }\n  .panel { border:1px solid #e5e7eb; border-radius:14px; background:#fff; padding:16px; }\n  .panel + .panel { margin-top:16px; }\n  .panel h3 { margin:0 0 10px; font-size:16px; }\n  .cards { display:flex; flex-wrap:wrap; gap:16px; }\n  .card { flex:1; min-width:220px; border-radius:12px; padding:16px; }\n  .card h4 { margin:0 0 8px; font-size:14px; font-weight:600; }\n  .divider { height:1px; background:linear-gradient(90deg,#f0f2f4,transparent); margin:14px 0; }\n  .muted { color:#6b7280; }\n  .btn { padding:6px 10px; border-radius:8px; border:1px solid #d0d7de; background:#f6f8fa; cursor:pointer; }\n  .btn-alt { background:#fff1f2; border-color:#ffd0d0; }\n  .btn-ok  { background:#e8f5e9; border-color:#b7ebc6; }\n  table.clean { width:100%; border-collapse:collapse; font-size:14px; }\n  table.clean th, table.clean td { padding:10px 12px; border-bottom:1px solid #f1f5f9; }\n  table.clean thead th { background:#f9fafb; border-bottom:1px solid #e5e7eb; }\n  .pill { display:inline-block; padding:.25rem .55rem; border-radius:999px; font-size:.85rem; font-weight:600; border:1px solid transparent; }\n  .pill-ok  { background:#e6f4ea; color:#0f5132; border-color:#badbcc; }\n  .pill-warn{ background:#fff3cd; color:#8a6d3b; border-color:#ffe69c; }\n  .pill-bad { background:#fee2e2; color:#991b1b; border-color:#fecaca; }\n  .section-title { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }\n  .section-title small { color:#6b7280; font-weight:500; }\n</style>\n\n<div class=\"vmcd-wrap\">\n  <h2 style=\"margin:0 0 10px\">🚑 Vehicle Maintenance & Commission Dashboard</h2>\n\n  <!-- View Controls -->\n  <div class=\"toolbar panel\" id=\"sec-controls\">\n    <div class=\"muted\" style=\"margin-right:6px;\">View:</div>\n    <label class=\"chip\"><input type=\"checkbox\" data-target=\"#sec-maint\" checked> Maintenance KPIs</label>\n    <label class=\"chip\"><input type=\"checkbox\" data-target=\"#sec-commission\" checked> Commission Snapshot</label>\n    <label class=\"chip\"><input type=\"checkbox\" data-target=\"#sec-region-wo\" checked> Regional WOs</label>\n    <label class=\"chip\"><input type=\"checkbox\" data-target=\"#sec-trend\" checked> Trend Chart</label>\n    <label class=\"chip\"><input type=\"checkbox\" data-target=\"#sec-crosstab\"> Completed by Vehicle</label>\n\n    <div style=\"margin-left:auto; display:flex; gap:8px; align-items:center;\">\n      <form method=\"get\" style=\"display:flex; gap:8px; align-items:center; margin:0;\">\n        <label for=\"year\" class=\"muted\">Year</label>\n        <select name=\"year\" id=\"year\" onchange=\"this.form.submit()\" class=\"btn\" style=\"padding:.4rem .6rem;\">\n          <option value=\"all\"'.($selYear==='all'?' selected':'').'>All years</option>';\n          foreach($years as $y){ echo '<option value=\"'.h($y).'\"'.($selYear===$y?' selected':'').'>'.h($y).'</option>'; }\necho '   </select>\n        <noscript><button type=\"submit\" class=\"btn\">Apply</button></noscript>\n      </form>\n    </div>\n  </div>\n\n  <!-- Maintenance KPIs -->\n  <section id=\"sec-maint\" class=\"panel\">\n    <div class=\"section-title\"><h3>🧰 Maintenance Summary</h3><small class=\"muted\">'.($selYear==='all'?'Last 12 months view for chart':'Year '.$selYear).'</small></div>\n    <div class=\"cards\">\n      <div class=\"card\" style=\"background:#f0f4f8;\">\n        <h4>Total Work Orders'.($selYear==='all'?'':' ('.$selYear.')').'</h4>\n        <div style=\"font-size:28px; font-weight:800;\">'.fmtInt($total_wo).'</div>\n      </div>\n      <div class=\"card\" style=\"background:#e8f5e9;\">\n        <h4>Work Order Status</h4>\n        <div><b>Ongoing:</b> '.fmtInt($ongoing).'</div>\n        <div><b>Completed:</b> '.fmtInt($completed).'</div>\n      </div>\n      <div class=\"card\" style=\"background:#fff3e0;\">\n        <h4>Avg Turnaround Time</h4>\n        <div style=\"font-size:28px; font-weight:800;\">'.fmtFloat($avg_tat).' days</div>\n      </div>\n      <div class=\"card\" style=\"background:#ffebee;\">\n        <h4>Pending / Overdue</h4>\n        <div><b>Pending:</b> '.fmtInt($pending).'</div>\n        <div><b>Overdue &gt;14d:</b> '.fmtInt($overdue).'</div>\n      </div>\n      <div class=\"card\" style=\"background:#ede7f6;\">\n        <h4>Top Maintained Vehicle</h4>\n        <div>'.h($top_vehicle).'</div>\n      </div>\n    </div>\n  </section>\n\n  <!-- Commission Snapshot -->\n  <section id=\"sec-commission\" class=\"panel\">\n    <div class=\"section-title\"><h3>🚦 Commission Snapshot (OfficeType = STATION)</h3></div>\n    <div class=\"cards\" style=\"margin-bottom:10px;\">\n      <div class=\"card\" style=\"background:#f0f4f8;\"><h4>Total Stations (Vehicles)</h4><div style=\"font-size:28px; font-weight:800;\">'.fmtInt($commTotStations).'</div></div>\n      <div class=\"card\" style=\"background:#e8f5e9;\"><h4>In Commission (Working)</h4><div style=\"font-size:28px; font-weight:800;\">'.fmtInt($commTotWorking).' <span class=\"muted\">('.$commWorkPct.'%)</span></div></div>\n      <div class=\"card\" style=\"background:#ffebee;\"><h4>Out of Commission</h4><div style=\"font-size:28px; font-weight:800;\">'.fmtInt($commTotOOC).' <span class=\"muted\">('.($commTotStations>0? number_format(($commTotOOC/$commTotStations)*100,1):0).'%)</span></div><div class=\"muted\" style=\"margin-top:6px;\">In Workshop: '.fmtInt($commOOC_workshop).' · No Vehicle: '.fmtInt($commOOC_noveh).'</div></div>\n    </div>\n\n    <div class=\"panel\" style=\"padding:0;\">\n      <table class=\"clean\">\n        <thead>\n          <tr>\n            <th style=\"text-align:left;\">Region</th>\n            <th style=\"text-align:right;\">Working</th>\n            <th style=\"text-align:right;\">OOC</th>\n            <th style=\"text-align:right;\">Total</th>\n            <th style=\"text-align:right;\">In Comm %</th>\n            <th style=\"text-align:right;\">OOC %</th>\n            <th>Actions</th>\n          </tr>\n        </thead>\n        <tbody id=\"commissionRegionRows\"></tbody>\n      </table>\n    </div>\n  </section>\n\n  <!-- NEW: Regional Work Orders table -->\n  <section id=\"sec-region-wo\" class=\"panel\">\n    <div class=\"section-title\"><h3>🗂️ Regional Work Orders — Pending vs Completed</h3><small class=\"muted\">'.($selYear==='all'?'By request date (last 12m aggregate)':'By request date ('.$selYear.')').'</small></div>\n    <div class=\"panel\" style=\"padding:0;\">\n      <table class=\"clean\">\n        <thead>\n          <tr>\n            <th style=\"text-align:left;\">Region</th>\n            <th style=\"text-align:right;\">Pending WOs</th>\n            <th style=\"text-align:right;\">Completed WOs</th>\n            <th style=\"text-align:right;\">Total WOs</th>\n            <th style=\"text-align:right;\">Pending %</th>\n            <th style=\"text-align:right;\">Completed %</th>\n          </tr>\n        </thead>\n        <tbody>';\n          if(!$regionWOStats){\n            echo '<tr><td colspan=\"6\" class=\"muted\" style=\"text-align:center; padding:14px;\">No work orders found for the selected period.</td></tr>';\n          } else {\n            foreach($regionWOStats as $rw){\n              echo '<tr>\n                <td>'.h($rw['region']).'</td>\n                <td style=\"text-align:right;\">'.fmtInt($rw['pending']).'</td>\n                <td style=\"text-align:right;\">'.fmtInt($rw['completed']).'</td>\n                <td style=\"text-align:right;\">'.fmtInt($rw['total']).'</td>\n                <td style=\"text-align:right;\">'.fmtFloat($rw['pend_rate']).'%</td>\n                <td style=\"text-align:right;\">'.fmtFloat($rw['comp_rate']).'%</td>\n              </tr>';\n            }\n          }\necho '   </tbody>\n      </table>\n    </div>\n  </section>\n\n  <!-- Trend -->\n  <section id=\"sec-trend\" class=\"panel\">\n    <div class=\"section-title\"><h3>📈 Requested vs Completed vs Outstanding — '.$trendTitle.'</h3></div>\n    <div class=\"panel\" style=\"padding:12px;\">\n      <canvas id=\"woTrendChart\" height=\"120\"></canvas>\n    </div>\n  </section>\n\n  <!-- Cross-tab -->\n  <section id=\"sec-crosstab\" class=\"panel\" style=\"display:none;\">\n    <div class=\"section-title\"><h3>✅ Completed Work Orders by Vehicle and Month'.($selYear==='all'?'':' — '.$selYear).'</h3></div>\n    <div class=\"panel\" style=\"padding:0;\">\n      <table class=\"clean\" style=\"min-width:900px;\">\n        <thead>\n          <tr>\n            <th style=\"text-align:left;\">Vehicle</th>\n            <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th>\n            <th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>\n            <th style=\"text-align:right;\">Total</th>\n          </tr>\n        </thead>\n        <tbody>';\n          if(!$crosstabRows){\n            echo '<tr><td colspan=\"14\" class=\"muted\" style=\"text-align:center; padding:14px;\">No completed work orders found for the selected period.</td></tr>';\n          } else {\n            foreach($crosstabRows as $r){\n              echo '<tr>\n                <td style=\"font-weight:600;\">'.h($r['vehNo']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Jan']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Feb']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Mar']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Apr']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['May']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Jun']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Jul']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Aug']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Sep']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Oct']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Nov']).'</td>\n                <td style=\"text-align:center;\">'.fmtInt($r['Dec']).'</td>\n                <td style=\"text-align:right; font-weight:700;\">'.fmtInt($r['Total']).'</td>\n              </tr>';\n            }\n          }\necho '   </tbody>\n      </table>\n    </div>\n\n    <div style=\"display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; font-size:13px;\">\n      <span>Page '.fmtInt($page).' of '.fmtInt($totalPages).'</span>';\n      if($page>1){\n        echo '<a href=\"'.h(pageLink(1,$qsYear)).'\" class=\"btn\">« First</a>';\n        echo '<a href=\"'.h(pageLink($page-1,$qsYear)).'\" class=\"btn\">‹ Prev</a>';\n      } else {\n        echo '<span class=\"btn\" style=\"opacity:.5;\">« First</span><span class=\"btn\" style=\"opacity:.5;\">‹ Prev</span>';\n      }\n      if($page<$totalPages){\n        echo '<a href=\"'.h(pageLink($page+1,$qsYear)).'\" class=\"btn\">Next ›</a>';\n        echo '<a href=\"'.h(pageLink($totalPages,$qsYear)).'\" class=\"btn\">Last »</a>';\n      } else {\n        echo '<span class=\"btn\" style=\"opacity:.5;\">Next ›</span><span class=\"btn\" style=\"opacity:.5;\">Last »</span>';\n      }\necho ' </div>\n  </section>\n</div>\n\n<!-- Commission Modal -->\n<div id=\"commissionModal\" style=\"position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999;\">\n  <div style=\"background:#fff; width:min(900px, 92vw); max-height:85vh; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden; display:flex; flex-direction:column;\">\n    <div style=\"padding:12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;\">\n      <div id=\"commissionModalTitle\" style=\"font-weight:700;\">Stations</div>\n      <button type=\"button\" onclick=\"closeCommissionModal()\" class=\"btn\">Close ✕</button>\n    </div>\n    <div style=\"padding:0; overflow:auto;\">\n      <table class=\"clean\">\n        <thead style=\"position:sticky; top:0; background:#fafafa;\">\n          <tr>\n            <th style=\"text-align:left;\">Station</th>\n            <th style=\"text-align:left;\">Vehicle</th>\n            <th style=\"text-align:left;\">GPS</th>\n            <th style=\"text-align:left;\">Availability</th>\n            <th style=\"text-align:left;\">Status</th>\n          </tr>\n        </thead>\n        <tbody id=\"commissionModalBody\"></tbody>\n      </table>\n    </div>\n  </div>\n</div>\n';\n\n//////////////// Scripts //////////////////\n// JSON blobs\n$jsonLabels = json_encode($labels);\n$jsonTotal  = json_encode(array_values($seriesTotal));\n$jsonDone   = json_encode(array_values($seriesDone));\n$jsonOut    = json_encode(array_values($seriesOut));\n$jsonCommRegions  = json_encode(array_values($jsCommRegions));\n$jsonCommStations = json_encode($commStationsByReg);\n\necho <<<HTML\n<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n<script>\n(function(){\n  // --- View controls ---\n  document.querySelectorAll('#sec-controls input[type=\"checkbox\"]').forEach(function(cb){\n    function apply(){ var tgt=document.querySelector(cb.getAttribute('data-target')); if(!tgt) return; tgt.style.display = cb.checked ? '' : 'none'; }\n    cb.addEventListener('change', apply); apply();\n  });\n\n  // --- Trend chart ---\n  var labels=$jsonLabels, totalCum=$jsonTotal, doneCum=$jsonDone, outstanding=$jsonOut;\n  var el=document.getElementById('woTrendChart');\n  if(el){\n    new Chart(el.getContext('2d'),{\n      type:'line',\n      data:{ labels:labels, datasets:[\n        { label:'Requested (as at month)', data: totalCum, borderWidth:2, borderDash:[6,4], fill:false, tension:.3 },\n        { label:'Completed (as at month)', data: doneCum,  borderWidth:2, fill:false, tension:.3 },\n        { label:'Outstanding (as at month)', data: outstanding, borderWidth:2, fill:false, tension:.3 }\n      ]},\n      options:{ responsive:true, interaction:{mode:'index',intersect:false},\n        plugins:{ legend:{position:'top'}, tooltip:{enabled:true}},\n        scales:{ y:{beginAtZero:true, ticks:{precision:0}}, x:{grid:{display:false}} }\n      }\n    });\n  }\n\n  // --- Commission table + actions ---\n  var regions=$jsonCommRegions;      // [{region_id,name,total,working,ooc,work_rate,ooc_rate}]\n  var stationsByRegion=$jsonCommStations; // { rid: [ {station,vehicle,gps,avail,status,is_ooc} ] }\n  regions.sort(function(a,b){ return (a.name||'').localeCompare(b.name||''); });\n\n  var tbody=document.getElementById('commissionRegionRows');\n  if(tbody){\n    regions.forEach(function(r){\n      var tr=document.createElement('tr');\n\n      function td(txt, ar){ var t=document.createElement('td'); t.textContent=txt; if(ar) t.style.textAlign='right'; t.style.padding='10px 12px'; t.style.borderBottom='1px solid #f1f5f9'; return t; }\n\n      var cRegion=td(r.name,false);\n      cRegion.style.fontWeight='600';\n      cRegion.style.cursor='pointer';\n      cRegion.title='Click to view ALL stations';\n      cRegion.onclick=function(){ openCommissionModal(r.region_id, r.name, 'all'); };\n\n      var cWorking=td((r.working||0).toLocaleString(),true);\n      var cOOC    =td((r.ooc||0).toLocaleString(),true);\n      var cTotal  =td((r.total||0).toLocaleString(),true);\n      var cWorkRt =td((r.total>0?((r.working/r.total)*100).toFixed(1)+'%':'0%'),true);\n      var cOocRt  =td((r.total>0?((r.ooc    /r.total)*100).toFixed(1)+'%':'0%'),true);\n\n      var cAct=document.createElement('td'); cAct.style.padding='10px 12px'; cAct.style.borderBottom='1px solid #f1f5f9';\n      var btnIn=document.createElement('button'); btnIn.className='btn btn-ok'; btnIn.textContent='Stations in Commission';\n      btnIn.style.marginRight='8px'; btnIn.onclick=function(){ openCommissionModal(r.region_id, r.name, 'in'); };\n      var btnO=document.createElement('button'); btnO.className='btn btn-alt'; btnO.textContent='OOC Only';\n      btnO.onclick=function(){ openCommissionModal(r.region_id, r.name, 'ooc'); };\n      cAct.appendChild(btnIn); cAct.appendChild(btnO);\n\n      tr.appendChild(cRegion); tr.appendChild(cWorking); tr.appendChild(cOOC); tr.appendChild(cTotal); tr.appendChild(cWorkRt); tr.appendChild(cOocRt); tr.appendChild(cAct);\n      tbody.appendChild(tr);\n    });\n  }\n\n  // Modal helpers\n  window.openCommissionModal=function(regionId, regionName, filterMode){\n    var modal=document.getElementById('commissionModal');\n    var title=document.getElementById('commissionModalTitle');\n    var body=document.getElementById('commissionModalBody');\n    var heading='Stations — '; if(filterMode==='in') heading='In Commission — '; if(filterMode==='ooc') heading='Out of Commission — ';\n    title.textContent=heading+(regionName||''); body.innerHTML='';\n\n    var list=stationsByRegion[regionId]||[];\n    if(filterMode==='in'){ list=list.filter(function(x){return x.is_ooc==0;}); }\n    else if(filterMode==='ooc'){ list=list.filter(function(x){return x.is_ooc==1;}); }\n\n    if(list.length===0){\n      var tr=document.createElement('tr'); var td=document.createElement('td'); td.colSpan=5; td.className='muted'; td.style.textAlign='center'; td.style.padding='14px'; td.textContent='No stations found.'; tr.appendChild(td); body.appendChild(tr);\n    }else{\n      list.sort(function(a,b){ return (a.station||'').localeCompare(b.station||''); });\n      list.forEach(function(s){\n        var tr=document.createElement('tr'); tr.style.borderBottom='1px solid #f6f6f6';\n        function cell(txt){ var td=document.createElement('td'); td.style.padding='10px 12px'; td.textContent=txt||''; return td; }\n        var td1=cell(s.station), td2=cell(s.vehicle), td3=cell(s.gps), td4=cell(s.avail);\n        var td5=document.createElement('td'); td5.style.padding='10px 12px';\n        var pill=document.createElement('span'); pill.className='pill '+(s.status==='Working'?'pill-ok':(s.status==='In Workshop'?'pill-warn':'pill-bad')); pill.textContent=s.status||''; td5.appendChild(pill);\n        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5); body.appendChild(tr);\n      });\n    }\n    modal.style.display='flex';\n  };\n  window.closeCommissionModal=function(){ document.getElementById('commissionModal').style.display='none'; };\n})();\n</script>\nHTML;\n"
}